import { Injectable } from '@angular/core';import { fromEvent, Observable, Subject } from 'rxjs';import { BasisVariableDef, CodingScheme } from '@response-scheme';@Injectable({  providedIn: 'root'})export class VeronaAPIService {  sessionID: string = '';  private _vosStartCommand = new Subject<VosStartCommand>();  private _vosGetSchemeRequest = new Subject<VosGetSchemeRequest>();  private isStandalone = (): boolean => window === window.parent;  constructor() {    fromEvent(window, 'message')      .subscribe((event: Event): void => {        this.handleMessage((event as MessageEvent).data);      });  }  private handleMessage(messageData: VosGetSchemeRequest | VosStartCommand): void {    switch (messageData.type) {      case 'vosStartCommand':        this.sessionID = messageData.sessionId;        this._vosStartCommand.next(messageData as VosStartCommand);        break;      case 'vosGetSchemeRequest':        this._vosGetSchemeRequest.next(messageData);        break;      default:        console.warn(`schemer: got message of unknown type ${messageData}`);    }  }  private send(message: Record<string, string>): void {    // prevent posts in local (dev) mode    if (!this.isStandalone()) {      window.parent.postMessage(message, '*');    } else {      console.log('schemer: send ', message);    }  }  sendVosReadyNotification( metaData: Record<string, string> ): void {    this.send({      type: 'vosReadyNotification',      ...metaData    });  }  sendVosSchemeChangedNotification(scheme: CodingScheme[]): void {    console.log('schemer: sendVosSchemeChangedNotification ', scheme);    this.send({      type: 'vosSchemeChangedNotification',      sessionId: this.sessionID,      timeStamp: String(Date.now()),      codingScheme: JSON.stringify(scheme),      codingSchemeType: 'iqb@1.0'    });  }  get vosStartCommand(): Observable<VosStartCommand> {    return this._vosStartCommand.asObservable();  }  get vosGetSchemeRequest(): Observable<VosGetSchemeRequest> {    return this._vosGetSchemeRequest.asObservable();  }}export interface VosStartCommand {  type: 'vosStartCommand'  sessionId: string,  codingScheme?: string,  codingSchemeType?: string,  variables: BasisVariableDef[]}export interface VosGetSchemeRequest extends MessageEvent {  type: 'vosGetSchemeRequest'  sessionId: string}